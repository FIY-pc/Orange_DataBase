# ODB设计文档

------

## 大致框架

### 语言与环境

C语言、Linux、使用CMake进行编译



### Orange协议(以下简称ORP)

#### 基本格式

请求格式：

| 头部     | 说明                |
| -------- | ------------------- |
| 协议版本 | char[4] 例："1.0\0" |
| 请求方法 | GET SET DELETE      |

字节流形式：

```c
4byte 	1byte	后跟ORP格式数据
协议版本 请求方法
char[4]	 char
```

请求方法：

get：'1'

set：'2'

delete：'3'

响应格式：

| 响应头   | 说明                |
| -------- | ------------------- |
| 协议版本 | char[4] 例："1.0\0" |
| 状态码   | 例："100\0"         |

字节流形式：

```c
4byte 	4byte	后跟ORP格式数据
协议版本 状态码
char[4]	 char[4]
```

#### ORP数据格式

##### SDS格式

类型标识符：'1'

SDS从客户端发送来之后，将会以字符数组的形式写入数据库，取出时经过SDS的转换API重新变为SDS

```c
1byte		4byte		n*byte	
类型标识符	总字符长度	 字符数组
char 		int			char[n]
```

##### 列表格式

类型标识符：0x03



------

### 通信模块

#### socket主文件

使用TCP协议进行连接，应用层协议采用ORP，若有可能，应实现对每个提交的事务创建单独协程实现并发处理



#### ORP协议

##### 请求解析器

##### 响应解析器

##### 命令解析器模块

将命令进行分割、解析。

10.02更新：为减轻服务器负担，数据类型的解析工作在客户端完成以减少高并发情形下服务器的解析性能占用

实现方法：

基本命令格式如下：

例：set(key,value) (若有可能，应实现能一次set多个键值对的命令)

​	get(key)(若有可能，应实现能一次get多个值的命令)

​	delete(key)(若有可能，应实现能一次delete多个键值对的命令)

------

### 数据结构模块(基石)

10.02更新：若无更好办法，此模块将被嵌入数据层实现模块以保持模块的高内聚



此部分提供应有的数据结构定义，以及用于操作这些数据结构的API

#### 哈希表

#### SDS

应提供的基本函数：sdslen()、

#### 列表

#### 集合

......

------

### 数据层实现模块

#### 基本硬盘io模块

#### 快照模块

#### AOF模块

#### 事务模块

------



## 服务端

### config.h

规定此版本服务端一般参数配置



### server主文件



### ORP协议

#### ORPSET.h

规定ORP协议参数

#### 请求解析器



### 数据结构模块

### 数据层实现模块

------



## 客户端

### config.h

规定此版本客户端一般参数配置



### client主文件(socket)



### ORP协议



#### ORPSET.h

规定ORP协议参数

#### 命令解析器

将命令序列化，添加头部成为ORP请求

#### 响应解析器

将ORP响应反序列化，输出响应内容